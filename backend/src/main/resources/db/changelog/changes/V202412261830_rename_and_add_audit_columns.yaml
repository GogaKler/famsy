databaseChangeLog:
  - changeSet:
      id: V202412261830
      author: egor.kolesnikov
      comment: "Add audit columns and rename users table"

      # Предусловие - проверяем существование таблицы
      preConditions:
        - onFail: MARK_RAN
        - onError: HALT
        - and:
          - tableExists:
              tableName: user_entity
          - not:
              tableExists:
                tableName: users

      changes:
        - renameTable:
            oldTableName: user_entity
            newTableName: users
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: modified_at
                  type: timestamp
              - column:
                  name: created_by
                  type: varchar(255)
                  constraints:
                    nullable: false
                  defaultValue: 'SYSTEM'
              - column:
                  name: modified_by
                  type: varchar(255)

        # Индексы
        - createIndex:
            tableName: users
            indexName: idx_users_created_at
            columns:
              - column:
                  name: created_at
        - createIndex:
            tableName: users
            indexName: idx_users_modified_at
            columns:
              - column:
                  name: modified_at

        # Заполнение данных
        - sql:
            sql: >
              UPDATE users 
              SET created_at = CURRENT_TIMESTAMP,
                  created_by = 'SYSTEM'
              WHERE created_at IS NULL

      # Откат
      rollback:
        - dropIndex:
            tableName: users
            indexName: idx_users_modified_at
        - dropIndex:
            tableName: users
            indexName: idx_users_created_at

        - dropColumn:
            tableName: users
            columnName: modified_by
        - dropColumn:
            tableName: users
            columnName: created_by
        - dropColumn:
            tableName: users
            columnName: modified_at
        - dropColumn:
            tableName: users
            columnName: created_at

        - renameTable:
            oldTableName: users
            newTableName: user_entity